## Windows Service Integration Configuration for EXL Infrastructure
## File: C:\ProgramData\Datadog\conf.d\windows_service.d\conf.yaml
## Purpose: Monitor 13 Windows Core Services as per EXL-Datadog Agreement
## Target: 2800 Windows Servers
## Priority: P2 Critical Monitoring

init_config:

instances:
  ## Instance 1: Critical Windows Core Services
  - services:
      ## DHCP Client - Network IP assignment
      - ^Dhcp$
      
      ## DNS Client - Name resolution
      - ^Dnscache$
      
      ## Plug and Play - Hardware device management
      - ^PlugPlay$
      
      ## Remote Procedure Call (RPC) - Inter-process communication
      - ^RpcSs$
      
      ## Server - File and print sharing
      - ^LanmanServer$
      
      ## TCP/IP NetBIOS Helper - NetBIOS name resolution
      - ^LmHosts$
      
      ## Windows Event Log - System event logging
      - ^EventLog$
      
      ## Windows Firewall - Network security
      - ^MpsSvc$
      
      ## Windows Remote Management (WinRM) - Remote management
      - ^WinRM$
      
      ## Workstation - Client network connections
      - ^LanmanWorkstation$
      
      ## Computer Browser - Network browsing service
      - ^Browser$
      
      ## Windows Management Instrumentation (WMI) - System management
      - ^Winmgmt$
      
      ## Note: Max Concurrent API Monitor is not a standard Windows service
      ## This requires custom monitoring via performance counters or WMI queries

    ## Tag services with their startup type (Automatic, Manual, Disabled)
    windows_service_startup_type_tag: true
    
    ## Add service display name as a tag for better identification
    collect_display_name_as_tag: true
    
    ## Custom tags for monitoring and alerting
    tags:
      - service_group:windows_core_services
      - monitor_priority:p2
      - environment:production
      - project:exl_scom_migration
      - monitored_by:datadog
      - alert_channel:servicenow
      - team:exl_infra
      - server_type:windows_computer

    ## Optional: Disable specific services if not applicable to all servers
    # disable_legacy_service_tag: false

## Metrics generated by this configuration:
## - windows_service.state (Service Check)
##   * OK (0): Service is running
##   * CRITICAL (2): Service is stopped
##   * UNKNOWN (3): Cannot determine service state
##
## Tags applied to each metric:
##   - windows_service:<service_name>
##   - display_name:<service_display_name>
##   - startup_type:<automatic|manual|disabled>
##   - All custom tags listed above

## Monitor Configuration in Datadog UI:
## 1. Navigate to Monitors > New Monitor > Service Check
## 2. Select: windows_service.state
## 3. Alert Condition: Service state is CRITICAL for 1 minute
## 4. Scope: Filter by tags (e.g., service_group:windows_core_services)
## 5. Alert Message Template:
##    {{#is_alert}}
##    ðŸ”´ CRITICAL: {{windows_service.name}} service is DOWN on {{host.name}}
##    Service: {{display_name.name}}
##    Startup Type: {{startup_type.name}}
##    Environment: production
##    Action: Immediate investigation required
##    {{/is_alert}}
##    
##    {{#is_recovery}}
##    âœ… RECOVERY: {{windows_service.name}} service is RUNNING on {{host.name}}
##    {{/is_recovery}}
##
## 6. Notification Settings:
##    - ServiceNow integration for P2 alerts
##    - Email: exl-infra-team@exlservice.com
##    - Escalation: After 5 minutes if unacknowledged

## Deployment Instructions:
## 1. Copy this file to: C:\ProgramData\Datadog\conf.d\windows_service.d\conf.yaml
## 2. Validate syntax: datadog-agent configcheck
## 3. Restart agent: Restart-Service datadogagent
## 4. Verify metrics: datadog-agent status
##
## For bulk deployment across 2800 servers, use PowerShell script:
##
## $servers = Get-Content "servers.txt"
## $yamlPath = "windows_service.yaml"
## 
## foreach ($server in $servers) {
##     $dest = "\\$server\c$\ProgramData\Datadog\conf.d\windows_service.d\conf.yaml"
##     Copy-Item $yamlPath -Destination $dest -Force
##     Invoke-Command -ComputerName $server -ScriptBlock {
##         Restart-Service -Name datadogagent -Force
##     }
##     Write-Host "âœ“ Configured: $server"
## }

## Troubleshooting:
## - Service not found: Verify service exists using 'Get-Service' cmdlet
## - No metrics reported: Check agent logs at C:\ProgramData\Datadog\logs\agent.log
## - Permission issues: Ensure Datadog Agent runs with Local System privileges
## - Service name mismatch: Use 'sc query' to get exact service names

## Version: 1.0
## Last Updated: 2026-01-04
## Contact: EXL Infra Team / Datadog Implementation Team
